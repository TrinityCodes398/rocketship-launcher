<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Rocket Launch Simulator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c2e 0%, #1a1a4a 50%, #2d2d6b 100%);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Stars background */
        .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 2s infinite alternate; }
        @keyframes twinkle { 0% { opacity: 0.3; } 100% { opacity: 1; } }

        .container { position: relative; z-index: 2; min-height: 100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; }

        .mission-control {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 40px; text-align:center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            max-width: 600px; width:100%;
        }

        h1 { color:#fff; font-size:2.5rem; margin-bottom:30px; text-shadow:0 0 20px rgba(255,255,255,0.5); }
        .countdown-display { font-size:4rem; font-weight:bold; color:#ff6b35; margin:30px 0; text-shadow:0 0 30px rgba(255,107,53,0.8); font-family:'Courier New', monospace; }
        .status { font-size:1.2rem; color:#4ecdc4; margin:10px 0 20px; text-shadow:0 0 10px rgba(78,205,196,0.6); }

        .launch-button, .reset-button, .shop-button {
            color:white; border:none; padding:12px 28px; font-size:1rem; border-radius: 30px; cursor:pointer; margin:8px;
        }
        .launch-button { background: linear-gradient(45deg,#ff6b35,#f7931e); box-shadow: 0 4px 15px rgba(255,107,53,0.4); }
        .reset-button { background: linear-gradient(45deg,#4ecdc4,#44a08d); box-shadow: 0 4px 15px rgba(78,205,196,0.4); }
        .shop-button { background: linear-gradient(45deg,#6c5ce7,#4b6cff); box-shadow:0 4px 12px rgba(76,58,255,0.35); }

        .launch-pad { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 200px; height: 100px; z-index: 3; }

        /* Rocket uses CSS variables so skins can change colors */
        .rocket {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 120px; transition: all 0.2s linear; z-index: 4; pointer-events:none;
            --primary: #e74c3c; --accent: #34495e; --window: #3498db;
        }

        .rocket.launching { animation: launch 3s ease-in forwards; }
        @keyframes launch {
            0% { bottom: 100px; transform: translateX(-50%) scale(1); }
            50% { bottom: 50vh; transform: translateX(-50%) scale(0.8); }
            100% { bottom: 100vh; transform: translateX(-50%) scale(0.3); opacity: 0; }
        }

        .flames { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 40px; height: 60px; opacity:0; transition: opacity .2s; z-index:3; }
        .flames.active { opacity:1; animation: flicker .1s infinite alternate; }
        @keyframes flicker { 0% { transform: translateX(-50%) scale(1); } 100% { transform: translateX(-50%) scale(1.1); } }

        .smoke { position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:100px; height:50px; opacity:0; z-index:2; }
        .smoke.active { opacity:.7; animation: smoke-rise 2s ease-out infinite; }
        @keyframes smoke-rise { 0% { transform: translateX(-50%) translateY(0) scale(1); opacity:.7; } 100% { transform: translateX(-50%) translateY(-100px) scale(2); opacity:0; } }

        .mission-info { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:30px; text-align:left; }
        .info-item { background: rgba(255,255,255,0.05); padding:15px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); }
        .info-label { color:#4ecdc4; font-size:.9rem; margin-bottom:5px; }
        .info-value { color:white; font-size:1.1rem; font-weight:bold; }

        /* HUD + Asteroids + Coins + Fuel */
        .hud { position: fixed; top: 14px; right: 14px; z-index: 6; display: flex; gap: 12px; align-items:center; }
        .hud-item { background: rgba(0,0,0,0.45); color:#fff; padding:8px 12px; border-radius:8px; font-weight:bold; border:1px solid rgba(255,255,255,0.06); display:flex; gap:8px; align-items:center; }

        .asteroid { position: fixed; width:40px; height:40px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #bbb 0%, #777 60%, #444 100%); z-index:5; pointer-events:none; box-shadow:0 2px 8px rgba(0,0,0,0.6); }

        .coin {
            position: fixed; width:28px; height:28px; border-radius:50%;
            background: radial-gradient(circle at 30% 30%, #ffd54d 0%, #f0b429 60%, #c28a00 100%);
            box-shadow:0 2px 8px rgba(0,0,0,0.5); z-index:5; pointer-events:none;
            display:flex; align-items:center; justify-content:center; font-weight:bold; color:#3a2a00; font-size:12px;
        }

        .fuel-pickup {
            position: fixed; width:26px; height:26px; border-radius:6px;
            background: linear-gradient(180deg,#6ec6ff,#2b7aa0);
            box-shadow:0 2px 8px rgba(0,0,0,0.5); z-index:5; pointer-events:none;
            display:flex; align-items:center; justify-content:center; color:#022d3a; font-weight:bold; font-size:12px;
            border:2px solid rgba(255,255,255,0.06);
        }

        /* shop modal */
        .shop-modal { position: fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:30; }
        .shop-panel { background:#0b1220; color:#fff; padding:20px; border-radius:12px; width:90%; max-width:720px; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
        .skins-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px; margin-top:12px; }
        .skin-card { background: rgba(255,255,255,0.03); padding:12px; border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.06); }
        .skin-swatch { width:60px; height:80px; margin:6px auto; border-radius:6px; display:block; }
        .skin-actions { margin-top:8px; display:flex; gap:6px; justify-content:center; }

        @media (max-width:768px) { .mission-control{padding:20px;} h1{font-size:2rem;} .countdown-display{font-size:3rem;} .mission-info{grid-template-columns:1fr;} }

        /* Signup / Signin / Forgot Password modal (shown on first run or via UI) */
        .shop-modal { position: fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:30; }
        .shop-panel { background:#0b1220; color:#fff; padding:20px; border-radius:12px; width:90%; max-width:480px; box-shadow:0 8px 30px rgba(0,0,0,0.6); }

        /* ...existing styles... */
    </style>
</head>
<body>
    <!-- Top bar: show signup/signin and quick multiplayer / AI buttons -->
    <div id="topbar" style="position:fixed;top:8px;left:8px;right:8px;z-index:40;display:flex;justify-content:space-between;gap:12px;align-items:center;pointer-events:auto;">
        <div style="display:flex;gap:8px;align-items:center;">
            <button id="signupHeaderBtn" style="display:none;padding:8px 12px;border-radius:8px;border:none;background:#4ecdc4;color:#022d3a;cursor:pointer">Sign up</button>
            <button id="signinHeaderBtn" style="display:none;padding:8px 12px;border-radius:8px;border:none;background:#ff6b35;color:#fff;cursor:pointer">Sign in</button>
            <span id="playerWelcome" style="color:#dbeafe;font-weight:600;"></span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
            <select id="destinationSelect" title="Choose destination" style="padding:8px;border-radius:8px;background:rgba(0,0,0,0.45);color:#fff;border:none">
                <option value="mars">Mars</option>
                <option value="jupiter">Jupiter</option>
                <option value="moon">Moon</option>
                <option value="saturn">Saturn</option>
            </select>
            <button id="aiToggleBtn" title="Play vs Computer" style="padding:8px 12px;border-radius:8px;border:none;background:#6c5ce7;color:#fff;cursor:pointer">Play vs Computer</button>
            <button id="multiplayerScanBtn" title="Scan for players" style="padding:8px 12px;border-radius:8px;border:none;background:#2b7aa0;color:#fff;cursor:pointer">Scan for players</button>
        </div>
    </div>

    <!-- Chat / lobby panel (hidden until WS connected) -->
    <div id="multiplayerPanel" style="position:fixed;right:12px;bottom:12px;width:320px;max-height:420px;background:rgba(4,6,23,0.9);border-radius:10px;padding:8px;display:none;flex-direction:column;gap:8px;z-index:50;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong style="color:#fff">Multiplayer Chat</strong>
            <button id="closeChat" style="background:#fff;color:#111;border-radius:6px;border:none;padding:4px 8px;cursor:pointer">Close</button>
        </div>
        <div id="chatLog" style="background:rgba(255,255,255,0.03);border-radius:6px;padding:8px;height:260px;overflow:auto;color:#e6f0ff;font-size:0.9rem;"></div>
        <div style="display:flex;gap:8px;">
            <input id="chatInput" placeholder="Say hello..." style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071023;color:#fff" />
            <button id="sendChat" style="padding:8px 10px;border-radius:6px;border:none;background:#4ecdc4;color:#022d3a;cursor:pointer">Send</button>
        </div>
    </div>

    <!-- Additional UI: skins/backgrounds chooser -->
    <div id="customizePanel" style="position:fixed;left:12px;bottom:12px;width:260px;background:rgba(4,6,23,0.9);border-radius:10px;padding:8px;z-index:50;color:#e6f0ff;">
        <div style="font-weight:700;margin-bottom:6px">Customize</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <select id="skinSelect" style="flex:1;padding:6px;border-radius:6px;background:#071023;color:#fff;border:none">
                <!-- skins populated by JS -->
            </select>
            <select id="bgSelect" style="flex:1;padding:6px;border-radius:6px;background:#071023;color:#fff;border:none">
                <!-- backgrounds populated by JS -->
            </select>
        </div>
    </div>

    <div class="stars" id="stars"></div>

    <div class="container">
        <div class="mission-control">
            <h1>üöÄ Mission Control</h1>
            <div class="status" id="status">Ready for Launch</div>
            <div class="countdown-display" id="countdown">10</div>

            <div>
                <button class="launch-button" id="launchBtn" onclick="startCountdown()">Start Launch Sequence</button>
                <button class="reset-button" id="resetBtn" onclick="resetMission()">Reset Mission</button>
                <button class="shop-button" id="shopBtn" onclick="openShop()">Customize Rocket</button>
            </div>

            <div class="mission-info">
                <div class="info-item">
                    <div class="info-label">Mission</div>
                    <div class="info-value">Mars Explorer</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Fuel Level</div>
                    <div class="info-value" id="fuel">100%</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Weather</div>
                    <div class="info-value">Clear Skies</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Launch Window</div>
                    <div class="info-value">Optimal</div>
                </div>
            </div>
        </div>
    </div>

    <div class="launch-pad">
        <svg width="200" height="100" viewBox="0 0 200 100">
            <rect x="0" y="80" width="200" height="20" fill="#666" />
            <rect x="80" y="70" width="40" height="30" fill="#888" />
            <circle cx="100" cy="85" r="3" fill="#ff6b35" />
        </svg>
    </div>

    <!-- Rocket SVG uses CSS vars for skin colors -->
    <div class="rocket" id="rocket">
        <svg width="60" height="120" viewBox="0 0 60 120">
            <ellipse cx="30" cy="20" rx="8" ry="20" fill="var(--primary)" />
            <rect x="22" y="20" width="16" height="60" fill="var(--primary)" />
            <rect x="20" y="80" width="20" height="20" fill="var(--accent)" />
            <polygon points="22,100 10,120 22,120" fill="var(--accent)" />
            <polygon points="38,100 50,120 38,120" fill="var(--accent)" />
            <circle cx="30" cy="35" r="6" fill="var(--window)" opacity="0.9" />
            <rect x="25" y="50" width="10" height="3" fill="#fff" />
            <rect x="25" y="55" width="10" height="3" fill="#fff" />
        </svg>
        <div class="flames" id="flames">
            <svg width="40" height="60" viewBox="0 0 40 60">
                <ellipse cx="20" cy="30" rx="15" ry="25" fill="#ff6b35" opacity="0.8" />
                <ellipse cx="20" cy="35" rx="10" ry="20" fill="#f39c12" opacity="0.9" />
                <ellipse cx="20" cy="40" rx="5" ry="15" fill="#fff" opacity="0.7" />
            </svg>
        </div>
    </div>

    <div class="smoke" id="smoke">
        <svg width="100" height="50" viewBox="0 0 100 50">
            <circle cx="20" cy="40" r="8" fill="#bdc3c7" opacity="0.6" />
            <circle cx="35" cy="35" r="12" fill="#95a5a6" opacity="0.5" />
            <circle cx="55" cy="38" r="10" fill="#bdc3c7" opacity="0.4" />
            <circle cx="75" cy="42" r="8" fill="#95a5a6" opacity="0.3" />
        </svg>
    </div>

    <div class="hud" id="hud">
        <div class="hud-item">Lives: <span id="lives">3</span></div>
        <div class="hud-item">Score: <span id="score">0</span></div>
        <div class="hud-item">Level: <span id="level">1</span></div>
        <div class="hud-item">Coins: <span id="coins">0</span> ‚çü</div>
    </div>

    <!-- Shop modal -->
    <div class="shop-modal" id="shopModal" onclick="if(event.target===this) closeShop()">
        <div class="shop-panel" role="dialog" aria-modal="true">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h2 style="margin:0">Rocket Shop</h2>
                <button onclick="closeShop()" style="background:#fff;color:#111;padding:6px 10px;border-radius:8px;border:none;cursor:pointer">Close</button>
            </div>
            <p style="margin-top:8px;color:#cbd5e1">Buy skins with coins earned by collecting coin pickups during flight.</p>
            <div class="skins-grid" id="skinsGrid"></div>
        </div>
    </div>

    <!-- Signup / Signin / Forgot Password modal (shown on first run or via UI) -->
    <div class="shop-modal" id="signupModal" onclick="if(event.target===this) document.getElementById('signupModal').style.display='none'">
        <div class="shop-panel" role="dialog" aria-modal="true" style="max-width:480px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h2 id="modalTitle" style="margin:0">Create Account</h2>
                <button onclick="document.getElementById('signupModal').style.display='none'" style="background:#fff;color:#111;padding:6px 10px;border-radius:8px;border:none;cursor:pointer">Close</button>
            </div>

            <!-- SIGNUP -->
            <form id="signupForm" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                <input id="su_username" placeholder="Display name" required style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071023;color:#fff" />
                <input id="su_email" type="email" placeholder="Email address" required style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071023;color:#fff" />
                <input id="su_password" type="password" placeholder="Password (min 6 chars)" required style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071023;color:#fff" />
                <label style="display:flex;align-items:center;gap:8px;font-size:0.95rem;color:#cbd5e1;">
                    <input id="su_subscribe" type="checkbox" /> Send me updates & news
                </label>
                <div style="display:flex;gap:8px;margin-top:6px;">
                    <button type="submit" style="flex:1;padding:10px;border-radius:8px;border:none;background:#4ecdc4;color:#022d3a;cursor:pointer">Create account</button>
                    <button type="button" id="showSignin" style="flex:1;padding:10px;border-radius:8px;border:none;background:#6c5ce7;color:#fff;cursor:pointer">Sign in</button>
                </div>
            </form>

            <!-- SIGNIN -->
            <form id="signinForm" style="margin-top:12px; display:none; flex-direction:column; gap:8px;">
                <input id="si_email" type="email" placeholder="Email" required style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071023;color:#fff" />
                <input id="si_password" type="password" placeholder="Password" required style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071023;color:#fff" />
                <div style="display:flex;gap:8px;margin-top:6px;">
                    <button type="submit" style="flex:1;padding:10px;border-radius:8px;border:none;background:#ff6b35;color:#fff;cursor:pointer">Sign in</button>
                    <button type="button" id="showSignup" style="flex:1;padding:10px;border-radius:8px;border:none;background:#444;color:#fff;cursor:pointer">Back</button>
                </div>
                <div style="margin-top:8px; text-align:right;">
                    <button type="button" id="showForgot" style="background:none;border:none;color:#cbd5e1;cursor:pointer;text-decoration:underline;padding:0;">Forgot password?</button>
                </div>
            </form>

            <!-- FORGOT PASSWORD -->
            <form id="forgotForm" style="margin-top:12px; display:none; flex-direction:column; gap:8px;">
                <div style="color:#cbd5e1">Enter your account email to receive a password reset link.</div>
                <input id="fp_email" type="email" placeholder="Email" required style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071023;color:#fff" />
                <div style="display:flex;gap:8px;margin-top:6px;">
                    <button type="button" id="sendResetBtn" style="flex:1;padding:10px;border-radius:8px;border:none;background:#6c5ce7;color:#fff;cursor:pointer">Send reset link</button>
                    <button type="button" id="backToSignin" style="flex:1;padding:10px;border-radius:8px;border:none;background:#444;color:#fff;cursor:pointer">Back</button>
                </div>
            </form>

            <!-- RESET SENT (simulated) -->
            <div id="resetSent" style="display:none;margin-top:12px;color:#cbd5e1;">
                If an account with that email exists we sent a reset link. (No real email is sent in this demo.)
                <div style="margin-top:8px;">
                    <button id="openResetLinkBtn" style="padding:8px;border-radius:8px;border:none;background:#4ecdc4;color:#022d3a;cursor:pointer">Open reset link</button>
                </div>
            </div>

            <!-- RESET PASSWORD FORM (visited via simulated link) -->
            <form id="resetForm" style="margin-top:12px; display:none; flex-direction:column; gap:8px;">
                <div style="color:#cbd5e1">Set a new password for your account.</div>
                <input id="rp_new" type="password" placeholder="New password (min 6 chars)" required style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071023;color:#fff" />
                <input id="rp_confirm" type="password" placeholder="Confirm password" required style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071023;color:#fff" />
                <div style="display:flex;gap:8px;margin-top:6px;">
                    <button id="resetSubmit" type="button" style="flex:1;padding:10px;border-radius:8px;border:none;background:#ff6b35;color:#fff;cursor:pointer">Reset password</button>
                    <button id="resetCancel" type="button" style="flex:1;padding:10px;border-radius:8px;border:none;background:#444;color:#fff;cursor:pointer">Cancel</button>
                </div>
            </form>

            <p id="signupNotice" style="margin-top:10px;color:#cbd5e1;font-size:0.9rem;">We use your email to send important updates about the game. Passwords are stored as a secure hash in your browser for this demo.</p>
        </div>
    </div>

    <script>
        // core variables
        let countdownInterval, isLaunching=false, currentCount=10;
        let flightMode=false;
        const rocketEl = document.getElementById('rocket');
        const flamesEl = document.getElementById('flames');
        const smokeEl = document.getElementById('smoke');
        const fuelEl = document.getElementById('fuel');
        const statusEl = document.getElementById('status');

        let keys = {};
        let rocketX=0, rocketY=0, rocketW=60, rocketH=120;
        let asteroids=[], asteroidId=0;
        let coinsOnField=[], coinId=0;
        let fuelPickups=[], fuelId=0;
        let gameLoopId=null, spawnIntervalId=null, fuelDrainInterval=null;
        let lives=3, score=0, fuel=100;
        let currentLevel=1, maxLevels=50, scorePerLevel=500;

        // persistence keys
        const STORAGE_COINS='rl_coins_v1';
        const STORAGE_OWNED='rl_owned_v1';
        const STORAGE_SELECTED='rl_selected_v1';
        const STORAGE_USER='rl_user_v1';
        const STORAGE_RESET='rl_reset_v1';

        let balance = parseInt(localStorage.getItem(STORAGE_COINS) || '0',10);
        let ownedSkins = JSON.parse(localStorage.getItem(STORAGE_OWNED) || '[]');
        let selectedSkin = localStorage.getItem(STORAGE_SELECTED) || 'skin-default';

        // skins (same as before)
        const skins = [
            { id:'skin-default', name:'Classic', price:0, colors:{primary:'#e74c3c', accent:'#34495e', window:'#3498db'} },
            { id:'skin-gold', name:'Golden', price:500, colors:{primary:'#ffd54d', accent:'#c28a00', window:'#6b4b00'} },
            { id:'skin-ice', name:'Ice Blue', price:1000, colors:{primary:'#6ec6ff', accent:'#2b7aa0', window:'#dff3ff'} },
            { id:'skin-neon', name:'Neon', price:2000, colors:{primary:'#9bff7a', accent:'#00bcd4', window:'#0ff'} },
            { id:'skin-violet', name:'Violet', price:3500, colors:{primary:'#8e44ad', accent:'#3c1361', window:'#c79bd6'} },
        ];

        // init HUD
        document.getElementById('coins').textContent = balance;
        if (!ownedSkins.includes('skin-default')) ownedSkins.push('skin-default');

        // stars
        function createStars(){ const starsContainer=document.getElementById('stars'); for(let i=0;i<100;i++){ const s=document.createElement('div'); s.className='star'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; const size=Math.random()*3+1; s.style.width=size+'px'; s.style.height=size+'px'; s.style.animationDelay=Math.random()*2+'s'; starsContainer.appendChild(s);} }
        createStars();

        // ---------------- SIGNUP / SIGNIN / PASSWORD RESET -----------------------
        async function sha256Hex(str){
            const enc = new TextEncoder();
            const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
            return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }

        function getSavedUser(){
            try { return JSON.parse(localStorage.getItem(STORAGE_USER) || 'null'); } catch(e){ return null; }
        }

        function saveUser(user){
            localStorage.setItem(STORAGE_USER, JSON.stringify(user));
        }

        // reset token storage helpers
        function saveResetToken(obj){
            localStorage.setItem(STORAGE_RESET, JSON.stringify(obj));
        }
        function getResetToken(){
            try { return JSON.parse(localStorage.getItem(STORAGE_RESET) || 'null'); } catch(e){ return null; }
        }
        function clearResetToken(){ localStorage.removeItem(STORAGE_RESET); }

        // modal helpers
        function showSignupModal(){ document.getElementById('signupModal').style.display='flex'; }
        function hideSignupModal(){ document.getElementById('signupModal').style.display='none'; }

        // toggle UI views inside modal
        function showView(view){
            document.getElementById('signupForm').style.display = view === 'signup' ? 'flex' : 'none';
            document.getElementById('signinForm').style.display = view === 'signin' ? 'flex' : 'none';
            document.getElementById('forgotForm').style.display = view === 'forgot' ? 'flex' : 'none';
            document.getElementById('resetSent').style.display = view === 'resetsent' ? 'block' : 'none';
            document.getElementById('resetForm').style.display = view === 'reset' ? 'flex' : 'none';
            document.getElementById('modalTitle').textContent = view === 'signin' ? 'Sign in' : view === 'forgot' ? 'Forgot Password' : view === 'reset' ? 'Reset Password' : 'Create Account';
        }

        // wire form toggle buttons
        document.addEventListener('click', ()=> {
            const ss = document.getElementById('showSignin');
            if(ss) ss.onclick = ()=> showView('signin');
            const su = document.getElementById('showSignup');
            if(su) su.onclick = ()=> showView('signup');
            const sf = document.getElementById('showForgot');
            if(sf) sf.onclick = ()=> showView('forgot');
            const backToSignin = document.getElementById('backToSignin');
            if(backToSignin) backToSignin.onclick = ()=> showView('signin');
        });

        // handle signup submit
        document.addEventListener('submit', async (ev)=>{
            if(ev.target && ev.target.id === 'signupForm'){
                ev.preventDefault();
                const username = document.getElementById('su_username').value.trim();
                const email = document.getElementById('su_email').value.trim().toLowerCase();
                const password = document.getElementById('su_password').value;
                const subscribe = document.getElementById('su_subscribe').checked;
                if(!username || !email || !password || password.length < 6){ alert('Please provide a username, a valid email and a password of at least 6 characters.'); return; }
                const hash = await sha256Hex(password);
                const user = { username, email, passHash: hash, subscribed: !!subscribe, created: Date.now() };
                saveUser(user);
                if(user.subscribed){ try { /* send to server if available */ } catch(e){} }
                hideSignupModal();
                alert('Account created. Welcome, ' + username + '!');
                afterUserReady();
            }
            if(ev.target && ev.target.id === 'signinForm'){
                ev.preventDefault();
                const email = document.getElementById('si_email').value.trim().toLowerCase();
                const password = document.getElementById('si_password').value;
                const saved = getSavedUser();
                if(!saved){ alert('No account found. Please create one.'); return; }
                const hash = await sha256Hex(password);
                if(saved.email === email && saved.passHash === hash){
                    hideSignupModal();
                    alert('Signed in. Welcome back, ' + saved.username + '!');
                    afterUserReady();
                } else {
                    alert('Invalid credentials.');
                }
            }
        });

        // password reset flow (simulated)
        document.getElementById('sendResetBtn').addEventListener('click', ()=> {
            const email = (document.getElementById('fp_email').value || '').trim().toLowerCase();
            if(!email){ alert('Enter your email'); return; }
            const user = getSavedUser();
            // generate token regardless to avoid revealing whether account exists
            const token = generateRandomToken();
            const expires = Date.now() + 1000 * 60 * 30; // 30 min
            saveResetToken({ token, email, expires });
            // show "sent" view and a simulated "open link" button
            showView('resetsent');
            // if the entered email matches saved user, keep button enabled, otherwise still show generic message
            const openBtn = document.getElementById('openResetLinkBtn');
            openBtn.onclick = ()=> {
                // only allow opening if token still valid
                const st = getResetToken();
                if(!st || st.token !== token){ alert('Reset link expired or invalid.'); return; }
                // simulate clicking the link: open reset form
                openResetLink(token);
            };
            // in a real app you'd send an email; here we simulate by storing token and letting user "open" it
            alert('If an account with that email exists, a reset link was (simulated) sent. Use "Open reset link" to continue.');
        });

        // open reset link (simulated)
        function openResetLink(token){
            const st = getResetToken();
            if(!st || st.token !== token || st.expires < Date.now()){
                alert('Reset link is invalid or expired.');
                return;
            }
            // show reset form
            showView('reset');
            // wire reset submit
            document.getElementById('resetSubmit').onclick = async () => {
                const p1 = document.getElementById('rp_new').value;
                const p2 = document.getElementById('rp_confirm').value;
                if(!p1 || p1.length < 6){ alert('Password must be at least 6 characters'); return; }
                if(p1 !== p2){ alert('Passwords do not match'); return; }
                // verify token again and update stored user if email matches
                const stored = getResetToken();
                if(!stored || stored.token !== token || stored.expires < Date.now()){
                    alert('Reset token expired or invalid.');
                    showView('signin');
                    return;
                }
                const savedUser = getSavedUser();
                if(savedUser && savedUser.email === stored.email){
                    const newHash = await sha256Hex(p1);
                    savedUser.passHash = newHash;
                    saveUser(savedUser);
                    clearResetToken();
                    alert('Password updated. You can now sign in.');
                    showView('signin');
                } else {
                    // for privacy, show generic message
                    clearResetToken();
                    alert('If an account matched that email the password was reset. Please sign in.');
                    showView('signin');
                }
            };
            document.getElementById('resetCancel').onclick = ()=> showView('signin');
        }

        function generateRandomToken(){
            const arr = new Uint8Array(12);
            crypto.getRandomValues(arr);
            return Array.from(arr).map(b => b.toString(16).padStart(2,'0')).join('');
        }

        // if first run, require sign up before playing
        function showSignupIfNeeded(){
            const user = getSavedUser();
            if(!user){
                showView('signup');
                showSignupModal();
            } else {
                // show signin view first so returning players can login immediately
                showView('signin');
                showSignupModal();
            }
        }

        function afterUserReady(){
            document.getElementById('coins').textContent = balance;
            if(selectedSkin) applySkinById(selectedSkin);
            window.openShop = openShop;
            window.closeShop = closeShop;
            const user = getSavedUser();
            if(user) statusEl.textContent = 'Welcome ' + (user.username || 'Player') + ' ‚Äî Ready for Launch';
        }

        // ----------------- SHOP population & other game code (unchanged) -----------
        function openShop(){
            populateShop();
            document.getElementById('shopModal').style.display='flex';
        }
        function closeShop(){ document.getElementById('shopModal').style.display='none'; }

        function populateShop(){
            const grid = document.getElementById('skinsGrid');
            grid.innerHTML='';
            skins.forEach(skin=>{
                const card = document.createElement('div'); card.className='skin-card';
                const sw = document.createElement('div'); sw.className='skin-swatch';
                sw.style.background = `linear-gradient(180deg, ${skin.colors.primary}, ${skin.colors.accent})`;
                sw.style.border = `2px solid rgba(255,255,255,0.06)`;
                card.appendChild(sw);
                const title = document.createElement('div'); title.textContent = skin.name; title.style.marginTop='6px';
                const price = document.createElement('div'); price.textContent = skin.price===0 ? 'FREE' : skin.price+' ‚çü';
                price.style.opacity='0.9'; price.style.fontSize='0.9rem';
                const actions = document.createElement('div'); actions.className='skin-actions';
                const buyBtn = document.createElement('button');
                buyBtn.textContent = ownedSkins.includes(skin.id) ? (selectedSkin===skin.id ? 'Selected' : 'Select') : 'Buy';
                buyBtn.style.padding='6px 8px'; buyBtn.style.border='none'; buyBtn.style.borderRadius='8px'; buyBtn.style.cursor='pointer';
                buyBtn.onclick = (e)=>{
                    e.stopPropagation();
                    if(ownedSkins.includes(skin.id)){
                        selectedSkin = skin.id;
                        applySkinById(selectedSkin);
                        localStorage.setItem(STORAGE_SELECTED, selectedSkin);
                        populateShop();
                    } else {
                        if(balance >= skin.price){
                            balance -= skin.price;
                            ownedSkins.push(skin.id);
                            localStorage.setItem(STORAGE_COINS, balance);
                            localStorage.setItem(STORAGE_OWNED, JSON.stringify(ownedSkins));
                            document.getElementById('coins').textContent = balance;
                            populateShop();
                        } else {
                            alert('Not enough coins.');
                        }
                    }
                };
                actions.appendChild(buyBtn);
                card.appendChild(title); card.appendChild(price); card.appendChild(actions);
                grid.appendChild(card);
            });
        }

        // ---------- New data: more skins & backgrounds & planet visuals ----------
        const EXTRA_SKINS = [
            { id:'skin-steel', name:'Steel', colors:{primary:'#9aa6ad', accent:'#3b4850', window:'#cfe6ff'} },
            { id:'skin-galactic', name:'Galactic', colors:{primary:'#1f8fff', accent:'#6a00ff', window:'#fff2b8'} },
            { id:'skin-sunflare', name:'Sunflare', colors:{primary:'#ffb86b', accent:'#c85b00', window:'#ffcfa3'} },
            { id:'skin-emerald', name:'Emerald', colors:{primary:'#00b894', accent:'#065f46', window:'#d6fff0'} },
        ];
        const BACKGROUNDS = [
            { id:'bg-space', name:'Deep Space', css:'linear-gradient(135deg,#0c0c2e 0%, #1a1a4a 50%, #2d2d6b 100%)' },
            { id:'bg-nebula', name:'Nebula', css:'radial-gradient(circle at 20% 20%, #2b0236 0%, #0d2233 40%, #071b2a 100%)' },
            { id:'bg-planetary', name:'Planetary', css:'linear-gradient(180deg,#001428,#061a2b 60%,#072233)' },
            { id:'bg-orbit', name:'Orbit View', css:'linear-gradient(180deg,#021022,#04162b 60%,#0b2540)' },
        ];
        // extend skins array used by shop
        skins.push(...EXTRA_SKINS);

        // populate skin/bg selects
        function populateCustomizer(){
            const skinSelect = document.getElementById('skinSelect');
            const bgSelect = document.getElementById('bgSelect');
            skinSelect.innerHTML = skins.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
            bgSelect.innerHTML = BACKGROUNDS.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
            // set defaults
            skinSelect.value = selectedSkin || 'skin-default';
            bgSelect.value = localStorage.getItem('rl_bg_selected') || 'bg-space';
        }
        populateCustomizer();

        function applyBackgroundById(id){
            const bg = BACKGROUNDS.find(b=>b.id===id);
            if(!bg) return;
            document.body.style.background = bg.css;
            localStorage.setItem('rl_bg_selected', id);
        }
        // apply chosen skin
        function applySkinById(id){
            const skin = skins.find(s=>s.id===id);
            if(!skin) return;
            rocketEl.style.setProperty('--primary', skin.colors.primary);
            rocketEl.style.setProperty('--accent', skin.colors.accent);
            rocketEl.style.setProperty('--window', skin.colors.window);
            selectedSkin = id;
            localStorage.setItem(STORAGE_SELECTED, selectedSkin);
            // update shop UI if open
            try { populateShop(); } catch(e){}
        }

        // wire customizer events
        document.getElementById('skinSelect').addEventListener('change', (e)=> applySkinById(e.target.value));
        document.getElementById('bgSelect').addEventListener('change', (e)=> applyBackgroundById(e.target.value));
        // initial apply
        applyBackgroundById(localStorage.getItem('rl_bg_selected') || 'bg-space');

        // ---------- First-run signin button visibility ----------
        function showHeaderAuthButtons(){
            const user = getSavedUser();
            const suBtn = document.getElementById('signupHeaderBtn');
            const siBtn = document.getElementById('signinHeaderBtn');
            const welcome = document.getElementById('playerWelcome');
            if(!user){
                suBtn.style.display = 'inline-block';
                siBtn.style.display = 'inline-block';
                welcome.textContent = '';
            } else {
                suBtn.style.display = 'none';
                siBtn.style.display = 'none';
                welcome.textContent = `Player: ${user.username}`;
            }
            suBtn.onclick = ()=> { showView('signup'); showSignupModal(); };
            siBtn.onclick = ()=> { showView('signin'); showSignupModal(); };
        }
        showHeaderAuthButtons();

        // ---------- AI opponent (simple simulated rocket) ----------
        let aiRunning = false, aiRocket = null;
        function startAIOpponent(){
            if(aiRunning) return;
            aiRunning = true;
            // create a simple AI entity that appears and dodges asteroids / collects coins
            aiRocket = document.createElement('div');
            aiRocket.style.position = 'fixed';
            aiRocket.style.width = (rocketW*0.9)+'px';
            aiRocket.style.height = (rocketH*0.9)+'px';
            aiRocket.style.right = '20px';
            aiRocket.style.top = (window.innerHeight*0.2)+'px';
            aiRocket.style.zIndex = 15;
            aiRocket.style.pointerEvents = 'none';
            aiRocket.innerHTML = `<svg width="${rocketW*0.9}" height="${rocketH*0.9}" viewBox="0 0 60 120"><ellipse cx="30" cy="20" rx="8" ry="20" fill="#9aa6ad"/><rect x="22" y="20" width="16" height="60" fill="#9aa6ad"/><circle cx="30" cy="35" r="6" fill="#cfe6ff" opacity="0.9"/></svg>`;
            document.body.appendChild(aiRocket);
            // simple movement loop
            const aiLoop = setInterval(()=> {
                if(!aiRunning) { clearInterval(aiLoop); return; }
                // random small moves
                const y = parseFloat(aiRocket.style.top) || 100;
                const ny = Math.max(40, Math.min(window.innerHeight - 200, y + (Math.random()-0.5)*60));
                aiRocket.style.top = ny + 'px';
            }, 600);
        }
        function stopAIOpponent(){
            aiRunning = false;
            if(aiRocket) aiRocket.remove();
            aiRocket = null;
        }
        document.getElementById('aiToggleBtn').addEventListener('click', ()=>{
            if(!flightMode) {
                // start single-player with AI
                startFlightMode(); // reuse existing start
            }
            if(!aiRunning){
                startAIOpponent();
                document.getElementById('aiToggleBtn').textContent = 'AI: ON';
            } else {
                stopAIOpponent();
                document.getElementById('aiToggleBtn').textContent = 'Play vs Computer';
            }
        });

        // ---------- Multiplayer scanning & chat (client-only placeholder using WebSocket) ----------
        let ws = null;
        const WS_URL = 'ws://localhost:3000'; // change to your server if available
        function scanForPlayers(){
            // try to connect to local websocket server to detect players / lobby
            try {
                ws = new WebSocket(WS_URL);
                ws.addEventListener('open', ()=> {
                    document.getElementById('multiplayerPanel').style.display = 'flex';
                    appendChatSys('Connected to lobby');
                    // announce presence
                    const me = getSavedUser() || {username:'Guest'};
                    ws.send(JSON.stringify({type:'join', name: me.username}));
                });
                ws.addEventListener('message', (m)=> {
                    try{
                        const d = JSON.parse(m.data);
                        if(d.type === 'chat') appendChat(`${d.name}: ${d.msg}`);
                        if(d.type === 'presence') appendChatSys(`${d.name} is ${d.status}`);
                    }catch(e){}
                });
                ws.addEventListener('close', ()=> appendChatSys('Disconnected from lobby'));
                ws.addEventListener('error', ()=> appendChatSys('Unable to connect to server'));
            } catch(e){
                appendChatSys('Scan failed');
            }
        }
        function appendChatSys(txt){ const c=document.getElementById('chatLog'); const el=document.createElement('div'); el.style.color='#9ee7ff'; el.style.margin='4px 0'; el.textContent = txt; c.appendChild(el); c.scrollTop = c.scrollHeight; }
        function appendChat(txt){ const c=document.getElementById('chatLog'); const el=document.createElement('div'); el.style.color='#e6f0ff'; el.style.margin='4px 0'; el.textContent = txt; c.appendChild(el); c.scrollTop = c.scrollHeight; }

        document.getElementById('multiplayerScanBtn').addEventListener('click', ()=>{
            appendChatSys('Scanning for players...');
            scanForPlayers();
        });
        document.getElementById('sendChat').addEventListener('click', ()=>{
            const input = document.getElementById('chatInput');
            const msg = (input.value||'').trim();
            if(!msg) return;
            const user = getSavedUser() || {username:'Guest'};
            if(ws && ws.readyState === WebSocket.OPEN){
                ws.send(JSON.stringify({type:'chat', name:user.username, msg}));
            } else {
                // local echo if no server
                appendChat(`${user.username}: ${msg}`);
            }
            input.value = '';
        });
        document.getElementById('closeChat').addEventListener('click', ()=>{
            document.getElementById('multiplayerPanel').style.display = 'none';
            try{ if(ws) ws.close(); }catch(e){}
        });

        // ---------- Destination selection visuals (planet preview & NASA-like blast) ----------
        const DEST_VIS = {
            mars: { preview: 'url(https://cdn.jsdelivr.net/gh/kennethrapp/astro@main/mars.jpg)', label:'Mars' },
            jupiter: { preview: '', label:'Jupiter' },
            moon: { preview: '', label:'Moon' },
            saturn: { preview: '', label:'Saturn' },
        };
        // small preview change when user selects a destination
        document.getElementById('destinationSelect').addEventListener('change', (e)=>{
            const dest = e.target.value;
            const info = DEST_VIS[dest] || {};
            // visual hint: change HUD color briefly and status
            statusEl.textContent = `Destination: ${info.label || dest}`;
            // flavor: change background slightly for gas giants
            if(dest === 'jupiter') document.body.style.background = 'linear-gradient(180deg,#24150f,#1b0f0a)';
            else applyBackgroundById(localStorage.getItem('rl_bg_selected') || 'bg-space');
        });

        // NASA-style blast: add a "launchStaging" effect on liftoff
        function nasaBlastEffect(){
            // strong smoke, camera shake and flame burst
            document.body.classList.add('camera-shake');
            flamesEl.classList.add('active');
            smokeEl.classList.add('active');
            setTimeout(()=> document.body.classList.remove('camera-shake'), 1400);
        }
        // camera shake CSS
        const css = document.createElement('style');
        css.innerHTML = `
        @keyframes camShake { 0% { transform: none } 25% { transform: translate(6px, -3px) rotate(-0.5deg); } 50% { transform: translate(-6px,2px) rotate(0.5deg); } 75% { transform: translate(3px,-2px) rotate(-0.3deg); } 100% { transform: none } }
        .camera-shake { animation: camShake .9s ease-in-out; }
        .nasa-flare { position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:80vw;height:80vh;pointer-events:none;mix-blend-mode:screen;opacity:0;transition:opacity .2s;z-index:60;background:radial-gradient(circle at 50% 60%, rgba(255,210,120,0.25) 0, rgba(255,90,40,0.12) 10%, rgba(0,0,0,0) 45%); }
        `;
        document.head.appendChild(css);
        const flare = document.createElement('div'); flare.className='nasa-flare'; document.body.appendChild(flare);

        // Hook into existing launch() to add NASA effect (preserve original launch implementation)
        const _origLaunch = window.launch || function(){};
        window.launch = function(){
            nasaBlastEffect();
            flare.style.opacity = '0.9';
            setTimeout(()=> flare.style.opacity = '0', 900);
            try{ _origLaunch(); } catch(e){ console.warn(e); }
        };

        // ---------- Ensure signup header & first-run flow ----------
        // reuse getSavedUser(), showHeaderAuthButtons already called earlier
        // show sign-up prompt on first page load if no user
        if(!getSavedUser()){
            document.getElementById('signupHeaderBtn').style.display = 'inline-block';
            document.getElementById('signinHeaderBtn').style.display = 'inline-block';
        }

        // make sure shop / skins are populated (re-populate if necessary)
        try { populateShop(); } catch(e){}

        // controls and countdown
        function startCountdown(){
            if(isLaunching) return;
            isLaunching=true;
            document.getElementById('launchBtn').disabled=true;
            statusEl.textContent='Launch Sequence Initiated';
            countdownInterval = setInterval(()=>{
                document.getElementById('countdown').textContent = currentCount;
                if(currentCount===3){ statusEl.textContent='Ignition Sequence Started'; flamesEl.classList.add('active'); smokeEl.classList.add('active'); }
                if(currentCount===0){ clearInterval(countdownInterval); launch(); return; }
                currentCount--;
            },1000);
        }
        function launch(){
            document.getElementById('countdown').textContent='LIFTOFF!';
            statusEl.textContent='üöÄ We have liftoff!';
            rocketEl.classList.remove('launching');
            startFlightMode();
        }

        function spawnIntervalForLevel(level){ return Math.max(250, 900 - (level-1)*12); }

        function startFlightMode(){
            flightMode=true;
            rocketEl.style.position='fixed';
            rocketW = rocketEl.offsetWidth || 60;
            rocketH = rocketEl.offsetHeight || 120;
            rocketX = (window.innerWidth - rocketW)/2;
            rocketY = window.innerHeight - 200;
            rocketEl.style.left = rocketX+'px';
            rocketEl.style.top = rocketY+'px';
            rocketEl.style.transform = 'none';
            flamesEl.classList.add('active');
            smokeEl.classList.add('active');

            // reset or resume (do not reset balance)
            currentLevel = 1;
            document.getElementById('level').textContent = currentLevel;
            lives = 3; score = 0; fuel = 100;
            document.getElementById('lives').textContent = lives;
            document.getElementById('score').textContent = score;
            fuelEl.textContent = fuel+'%';

            ensureFuelDrainRunning();

            if(spawnIntervalId) clearInterval(spawnIntervalId);
            spawnIntervalId = setInterval(spawnAsteroid, spawnIntervalForLevel(currentLevel));
            // coin spawn & fuel spawn
            setTimeout(scheduleCoinSpawn, 800);
            setTimeout(scheduleFuelSpawn, 2500);

            gameLoopId = requestAnimationFrame(gameLoop);
            window.addEventListener('keydown', onKeyDown);
            window.addEventListener('keyup', onKeyUp);
            initTouchControls();
        }

        function onKeyDown(e){ const k=e.key.toLowerCase(); if(['arrowleft','arrowright','arrowup','arrowdown','a','d','w','s'].includes(k)){ keys[k]=true; e.preventDefault(); } }
        function onKeyUp(e){ keys[e.key.toLowerCase()] = false; }

        function spawnAsteroid(){
            const size = 20 + Math.random()*60;
            const x = 10 + Math.random()*(window.innerWidth - size - 20);
            const y = -size - 10;
            const speed = 1.5 + Math.random()*3 + currentLevel*0.15;
            const el = document.createElement('div'); el.className='asteroid';
            el.style.width = size+'px'; el.style.height = size+'px'; el.style.left = x+'px'; el.style.top = y+'px';
            el.style.transform = 'rotate('+(Math.random()*360)+'deg)';
            document.body.appendChild(el);
            asteroids.push({ id: asteroidId++, el, x, y, size, speed, angle:Math.random()*Math.PI*2 });
        }

        // coins: spawn function & scheduler
        function scheduleCoinSpawn(){
            if(!flightMode) return;
            const next = 1500 + Math.random()*2500;
            setTimeout(()=>{
                if(flightMode) spawnCoin();
                scheduleCoinSpawn();
            }, next);
        }
        function spawnCoin(){
            const size = 28;
            const x = 10 + Math.random() * (window.innerWidth - size - 20);
            const y = -size - 10;
            const speed = 1 + Math.random()*2 + currentLevel*0.05;
            const el = document.createElement('div'); el.className='coin';
            el.style.width = size+'px'; el.style.height = size+'px'; el.style.left = x+'px'; el.style.top = y+'px';
            el.textContent = '‚ú™';
            document.body.appendChild(el);
            coinsOnField.push({ id: coinId++, el, x, y, size, speed, value: 50 });
        }

        // fuel pickups: spawn scheduler & spawn
        function scheduleFuelSpawn(){
            if(!flightMode) return;
            // spawn between 8s and 14s
            const next = 8000 + Math.random()*6000;
            setTimeout(()=>{
                if(flightMode) spawnFuel();
                scheduleFuelSpawn();
            }, next);
        }
        function spawnFuel(){
            const size = 26;
            const x = 10 + Math.random() * (window.innerWidth - size - 20);
            const y = -size - 10;
            const speed = 0.8 + Math.random()*1.6 + currentLevel*0.03;
            const el = document.createElement('div'); el.className='fuel-pickup';
            el.style.width = size+'px'; el.style.height = size+'px'; el.style.left = x+'px'; el.style.top = y+'px';
            el.innerHTML = '‚õΩ';
            document.body.appendChild(el);
            fuelPickups.push({ id: fuelId++, el, x, y, size, speed, value: 30 }); // value = fuel points
        }

        function gameLoop(){
            // movement only if fuel > 0
            const moveEnabled = fuel > 0;
            const moveSpeed = moveEnabled ? (5 + (100 - fuel) * 0.01) : 0;
            if(moveEnabled){
                if(keys['arrowleft'] || keys['a']) rocketX -= moveSpeed;
                if(keys['arrowright'] || keys['d']) rocketX += moveSpeed;
                if(keys['arrowup'] || keys['w']) rocketY -= moveSpeed;
                if(keys['arrowdown'] || keys['s']) rocketY += moveSpeed;
            } else {
                // when out of fuel, show a reminder
                statusEl.textContent = 'Out of fuel ‚Äî collect a fuel pickup!';
            }

            // keep inside viewport
            rocketX = Math.max(0, Math.min(window.innerWidth - rocketW, rocketX));
            rocketY = Math.max(0, Math.min(window.innerHeight - rocketH, rocketY));
            rocketEl.style.left = rocketX+'px';
            rocketEl.style.top = rocketY+'px';

            // update asteroids
            for(let i=asteroids.length-1;i>=0;i--){
                const a = asteroids[i];
                a.x += Math.sin(a.angle)*0.3; a.angle += 0.01; a.y += a.speed;
                a.el.style.left = a.x+'px'; a.el.style.top = a.y+'px';
                if(a.y > window.innerHeight + 50){ a.el.remove(); asteroids.splice(i,1); score += 10; document.getElementById('score').textContent = score; if(score >= currentLevel * scorePerLevel) advanceLevel(); continue; }
                const rocketRect = { x: rocketX, y: rocketY, w: rocketW, h: rocketH };
                const asteroidRect = { x: a.x, y: a.y, w: a.size, h: a.size };
                if(rectsOverlap(rocketRect, asteroidRect)){ a.el.remove(); asteroids.splice(i,1); handleCollision(); }
            }

            // update coins
            for(let i=coinsOnField.length-1;i>=0;i--){
                const c = coinsOnField[i];
                c.y += c.speed;
                c.el.style.top = c.y+'px';
                if(c.y > window.innerHeight + 50){ c.el.remove(); coinsOnField.splice(i,1); continue; }
                const rocketRect = { x: rocketX, y: rocketY, w: rocketW, h: rocketH };
                const coinRect = { x: c.x, y: c.y, w: c.size, h: c.size };
                if(rectsOverlap(rocketRect, coinRect)){
                    balance += c.value;
                    localStorage.setItem(STORAGE_COINS, balance);
                    document.getElementById('coins').textContent = balance;
                    c.el.style.transition = 'transform .2s, opacity .2s';
                    c.el.style.transform = 'scale(1.4)'; c.el.style.opacity = '0';
                    setTimeout(()=>{ c.el.remove(); }, 180);
                    coinsOnField.splice(i,1);
                }
            }

            // update fuel pickups
            for(let i=fuelPickups.length-1;i>=0;i--){
                const f = fuelPickups[i];
                f.y += f.speed;
                f.el.style.top = f.y+'px';
                if(f.y > window.innerHeight + 50){ f.el.remove(); fuelPickups.splice(i,1); continue; }
                const rocketRect = { x: rocketX, y: rocketY, w: rocketW, h: rocketH };
                const fuelRect = { x: f.x, y: f.y, w: f.size, h: f.size };
                if(rectsOverlap(rocketRect, fuelRect)){
                    // collect fuel
                    const prevFuel = fuel;
                    fuel = Math.min(100, fuel + f.value);
                    fuelEl.textContent = fuel + '%';
                    // small visual effect then remove
                    f.el.style.transition = 'transform .25s, opacity .25s';
                    f.el.style.transform = 'scale(1.3)'; f.el.style.opacity = '0';
                    setTimeout(()=>{ f.el.remove(); }, 240);
                    fuelPickups.splice(i,1);
                    // if we were out of fuel, resume drain and visuals
                    if(prevFuel === 0 && fuel > 0){
                        flamesEl.classList.add('active');
                        statusEl.textContent = 'Fuel restored ‚Äî engines back online';
                        ensureFuelDrainRunning();
                    }
                }
            }

            if(flightMode) gameLoopId = requestAnimationFrame(gameLoop);
        }

        function rectsOverlap(r1,r2){
            return !(r2.x > r1.x + r1.w || r2.x + r2.w < r1.x || r2.y > r1.y + r1.h || r2.y + r2.h < r1.y);
        }

        function handleCollision(){
            lives -=1; document.getElementById('lives').textContent = lives;
            statusEl.textContent = 'Collision! Hull breach detected!';
            flamesEl.classList.remove('active');
            setTimeout(()=>{ if(lives>0) statusEl.textContent='Keep dodging!'; else statusEl.textContent='Mission Failed üí•'; },800);
            if(lives<=0) endFlightMode(false);
        }

        function advanceLevel(){
            if(currentLevel >= maxLevels){ endFlightMode(true); return; }
            currentLevel++;
            document.getElementById('level').textContent = currentLevel;
            statusEl.textContent = 'Level '+currentLevel+' started ‚Äî reach '+(currentLevel*scorePerLevel)+' points total';
            if(spawnIntervalId) clearInterval(spawnIntervalId);
            spawnIntervalId = setInterval(spawnAsteroid, spawnIntervalForLevel(currentLevel));
            if(currentLevel % 5 === 0){ fuel = Math.min(100, fuel + 20); fuelEl.textContent = fuel+'%'; }
            if(currentLevel % 10 === 0){ lives = Math.min(5, lives + 1); document.getElementById('lives').textContent = lives; }
        }

        function endFlightMode(success){
            flightMode=false;
            if(gameLoopId) cancelAnimationFrame(gameLoopId);
            if(spawnIntervalId) clearInterval(spawnIntervalId);
            if(fuelDrainInterval) clearInterval(fuelDrainInterval);
            asteroids.forEach(a=>a.el.remove()); asteroids=[]; coinsOnField.forEach(c=>c.el.remove()); coinsOnField=[]; fuelPickups.forEach(f=>f.el.remove()); fuelPickups=[];
            window.removeEventListener('keydown', onKeyDown); window.removeEventListener('keyup', onKeyUp);
            destroyTouchControls();
            flamesEl.classList.remove('active'); smokeEl.classList.remove('active');
            if(success){ statusEl.textContent='Mission Successful! üéâ'; document.getElementById('countdown').textContent='SUCCESS'; } else { statusEl.textContent='Mission Failed üí•'; }
            document.getElementById('launchBtn').disabled = true;
        }

        function resetMission(){
            clearInterval(countdownInterval); isLaunching=false; currentCount=10; document.getElementById('countdown').textContent='10';
            statusEl.textContent='Ready for Launch'; document.getElementById('launchBtn').disabled=false;
            if(gameLoopId) cancelAnimationFrame(gameLoopId); if(spawnIntervalId) clearInterval(spawnIntervalId); if(fuelDrainInterval) clearInterval(fuelDrainInterval);
            asteroids.forEach(a=>a.el.remove()); asteroids=[]; coinsOnField.forEach(c=>c.el.remove()); coinsOnField=[]; fuelPickups.forEach(f=>f.el.remove()); fuelPickups=[];
            flamesEl.classList.remove('active'); smokeEl.classList.remove('active');
            fuel = 100; fuelEl.textContent = '100%'; lives = 3; score = 0; currentLevel = 1;
            document.getElementById('lives').textContent = lives; document.getElementById('score').textContent = score; document.getElementById('level').textContent = currentLevel;
            rocketEl.style.position='absolute'; rocketEl.style.left='50%'; rocketEl.style.transform='translateX(-50%)'; rocketEl.style.bottom='100px'; rocketEl.style.top='';
            rocketEl.classList.remove('launching');
            window.removeEventListener('keydown', onKeyDown); window.removeEventListener('keyup', onKeyUp);
            destroyTouchControls(); flightMode=false;
        }

        // ensure fuel drain runs while fuel > 0
        function ensureFuelDrainRunning(){
            if(fuelDrainInterval) clearInterval(fuelDrainInterval);
            fuelDrainInterval = setInterval(()=>{
                if(!flightMode) return;
                if(fuel <= 0){
                    // out of fuel: stop drain and visuals
                    clearInterval(fuelDrainInterval);
                    fuelDrainInterval = null;
                    flamesEl.classList.remove('active');
                    statusEl.textContent = 'Out of fuel ‚Äî collect fuel pickup!';
                    return;
                }
                fuel = Math.max(0, fuel - 1);
                fuelEl.textContent = fuel + '%';
                if(fuel === 0){
                    // remove flame visuals immediately
                    flamesEl.classList.remove('active');
                }
            }, 300);
        }

        // touch controls (mobile)
        let touchControls = null;
        function initTouchControls(){ if(touchControls) return; if(window.innerWidth > 800) return; touchControls = document.createElement('div'); touchControls.style.position='fixed'; touchControls.style.left='10px'; touchControls.style.bottom='10px'; touchControls.style.zIndex=20; touchControls.style.display='grid'; touchControls.style.gridTemplateColumns='repeat(3,56px)'; touchControls.style.gridTemplateRows='repeat(2,56px)'; touchControls.style.gap='8px'; const createBtn=(label,onStart,onEnd)=>{ const b=document.createElement('button'); b.textContent=label; b.style.width='56px'; b.style.height='56px'; b.style.borderRadius='12px'; b.style.fontSize='18px'; b.style.opacity='0.7'; b.addEventListener('touchstart', e=>{ onStart(); e.preventDefault(); }); b.addEventListener('touchend', e=>{ onEnd(); e.preventDefault(); }); return b; }; const up=createBtn('‚Üë', ()=>keys['w']=true, ()=>keys['w']=false); const left=createBtn('‚Üê', ()=>keys['a']=true, ()=>keys['a']=false); const down=createBtn('‚Üì', ()=>keys['s']=true, ()=>keys['s']=false); const right=createBtn('‚Üí', ()=>keys['d']=true, ()=>keys['d']=false); touchControls.appendChild(document.createElement('div')); touchControls.appendChild(up); touchControls.appendChild(document.createElement('div')); touchControls.appendChild(left); touchControls.appendChild(down); touchControls.appendChild(right); document.body.appendChild(touchControls); }
        function destroyTouchControls(){ if(!touchControls) return; touchControls.remove(); touchControls=null; }

        // Make sure UI shows coins & skin and then show signup/signin if needed
        document.getElementById('coins').textContent = balance;
        window.openShop = openShop;
        window.closeShop = closeShop;

        // start: check or show signup/signin/reset flows
        showSignupIfNeeded();

    </script>
</body>
</html>
